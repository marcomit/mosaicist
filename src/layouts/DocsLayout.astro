---
import Layout from '../components/Layout.astro';
import "../styles/global.css";

export interface Props {
  title: string;
  description?: string;
}

const { title, description } = Astro.props;
const fullTitle = `${title} - Mosaic Documentation`;

// Get current URL to determine active navigation
const currentPath = Astro.url.pathname;
---

<Layout title={fullTitle} description={description}>
  <main class="min-h-screen bg-cream text-charcoal">
    <!-- Sketchy Header -->
    <header class="relative px-6 py-8 bg-slate-50 border-b-2 border-charcoal">
      <div class="max-w-7xl mx-auto">
        <div class="flex items-center gap-6 mb-6">
          <!-- Hand-drawn Mini Logo -->
          <a href="/" class="mini-logo-link">
            <div class="mini-logo">
              <div class="mini-fragment mini-left"></div>
              <div class="mini-fragment mini-center"></div>
              <div class="mini-fragment mini-right"></div>
            </div>
          </a>
          
          <div>
            <a href="/docs" class="text-2xl font-medium text-charcoal hover:text-orange-500 transition-colors flex items-center gap-2" style="font-family: 'Inter', sans-serif;">
              <svg width="20" height="16" viewBox="0 0 20 16" class="sketchy-arrow-back">
                <path d="M8 2 L2 8 L8 14 M2 8 L18 8" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Documentation
            </a>
            <p class="text-sm text-slate-600 mt-1 font-tiempos">{title}</p>
          </div>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-6 py-8">
      <div class="grid lg:grid-cols-5 gap-12">
        <!-- Enhanced Sidebar Navigation -->
        <aside class="lg:col-span-1">
          <nav class="sticky top-8 space-y-6">
            <!-- Quick Start -->
            <div class="nav-section">
              <h3 class="text-lg font-semibold text-charcoal mb-4 flex items-center gap-3 font-styrene">
                <div class="nav-icon quick-start-icon"></div>
                Getting started
              </h3>
              <ul class="space-y-1 mt-2">
                <li><a href="/docs/installation" class={`nav-link ${currentPath === '/docs/installation' ? 'active' : ''}`}>Installation</a></li>
                <li><a href="/docs/project-structure" class={`nav-link ${currentPath === '/docs/project-structure' ? 'active' : ''}`}>Project structure</a></li>
              </ul>
            </div>

            <!-- Architecture -->
            <div class="nav-section">
              <h3 class="text-lg font-semibold text-charcoal mb-4 flex items-center gap-3 font-styrene">
                <div class="nav-icon architecture-icon"></div>
                Architecture
              </h3>
              <ul class="space-y-1">
                <li><a href="/docs/modules" class={`nav-link ${currentPath === '/docs/modules' ? 'active' : ''}`}>Modules</a></li>
                <li><a href="/docs/events" class={`nav-link ${currentPath === '/docs/events' ? 'active' : ''}`}>Events</a></li>
                <li><a href="/docs/router" class={`nav-link ${currentPath === '/docs/router' ? 'active' : ''}`}>Router</a></li>
                <li><a href="/docs/ui-injection" class={`nav-link ${currentPath === '/docs/ui-injection' ? 'active' : ''}`}>UI Injection</a></li>
                <li><a href="/docs/dependency-injection" class={`nav-link ${currentPath === '/docs/dependency-injection' ? 'active' : ''}`}>Dependency Injection</a></li>
                <li><a href="/docs/signals" class={`nav-link ${currentPath === '/docs/signals' ? 'active' : ''}`}>Signals</a></li>
                <li><a href="/docs/logger" class={`nav-link ${currentPath === '/docs/logger' ? 'active' : ''}`}>Logger</a></li>
                <li><a href="/docs/multithreading" class={`nav-link ${currentPath === '/docs/multithreading' ? 'active' : ''}`}>multithreading</a></li>
              </ul>
            </div>

            <!-- CLI -->
            <div class="nav-section">
              <h3 class="text-lg font-semibold text-charcoal mb-4 flex items-center gap-3 font-styrene">
                <div class="nav-icon architecture-icon"></div>
               CLI 
              </h3>
              <ul class="space-y-1">
                <li><a href="/docs/cli" class={`nav-link ${currentPath === '/docs/cli' ? 'active' : ''}`}>Getting started</a></li>
                <li><a href="/docs/profiles" class={`nav-link ${currentPath === '/docs/profiles' ? 'active' : ''}`}>Profiles</a></li>
              </ul>
            </div>
            <!-- Guides -->
            <div class="nav-section">
              <h3 class="text-lg font-semibold text-charcoal mb-4 flex items-center gap-3 font-styrene">
                <div class="nav-icon guides-icon"></div>
                Guides
              </h3>
              <ul class="space-y-1">
                <li><a href="/docs/guides/creating-modules" class={`nav-link ${currentPath === '/docs/guides/creating-modules' ? 'active' : ''}`}>Creating Modules</a></li>
                <li><a href="/docs/guides/event-patterns" class={`nav-link ${currentPath === '/docs/guides/event-patterns' ? 'active' : ''}`}>Event Patterns</a></li>
                <li><a href="/docs/guides/testing" class={`nav-link ${currentPath === '/docs/guides/testing' ? 'active' : ''}`}>Testing</a></li>
                <li><a href="/docs/guides/best-practices" class={`nav-link ${currentPath === '/docs/guides/best-practices' ? 'active' : ''}`}>Best Practices</a></li>
              </ul>
            </div>

            <!-- API Reference -->
            <div class="nav-section">
              <h3 class="text-lg font-semibold text-charcoal mb-4 flex items-center gap-3 font-styrene">
                <div class="nav-icon api-icon"></div>
                API Reference
              </h3>
              <ul class="space-y-1">
                <li><a href="/docs/api/core" class={`nav-link ${currentPath === '/docs/api/core' ? 'active' : ''}`}>Core Classes</a></li>
                <li><a href="/docs/api/utilities" class={`nav-link ${currentPath === '/docs/api/utilities' ? 'active' : ''}`}>Utilities</a></li>
                <li><a href="/docs/api/widgets" class={`nav-link ${currentPath === '/docs/api/widgets' ? 'active' : ''}`}>Widgets</a></li>
              </ul>
            </div>

            <!-- Hand-drawn decoration -->
            <div class="mt-12">
              <svg width="120" height="40" viewBox="0 0 120 40" class="opacity-30">
                <path d="M10 20 Q30 10 60 20 T110 15" stroke="#FB923C" stroke-width="2" fill="none" stroke-linecap="round"/>
                <circle cx="20" cy="18" r="2" fill="#FB923C"/>
                <circle cx="50" cy="22" r="1.5" fill="#60A5FA"/>
                <circle cx="90" cy="16" r="2.5" fill="#4ADE80"/>
              </svg>
            </div>
          </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="lg:col-span-3">
          
          <article class="prose-mosaic relative z-10">
            <slot />
          </article>

          <!-- Next/Previous Navigation -->
          <nav class="mt-16 pt-8 border-t-2 border-slate-200">
            <div class="flex justify-between items-center">
              <div class="prev-page">
                <!-- Will be populated by navigation logic -->
              </div>
              <div class="next-page">
                <!-- Will be populated by navigation logic -->
              </div>
            </div>
          </nav>
        </main>

        <!-- Table of Contents Sidebar -->
        <aside class="lg:col-span-1 hidden lg:block">
          <div class="sticky top-8">
            <!-- Fixed: Removed transform rotation and improved styling -->
            <div class="toc-container p-6 bg-slate-50/80 backdrop-blur-sm border-2 border-slate-200 rounded-lg shadow-sm">
              <div class="absolute -top-2 left-6 bg-cream px-3 py-1 rounded">
                <span class="text-sm font-medium text-slate-600 font-styrene">On this page</span>
              </div>
              
              <!-- Table of Contents will be generated by JavaScript -->
              <nav class="toc-nav mt-2">
                <ul id="toc-list" class="space-y-1">
                  <!-- TOC items will be inserted here -->
                </ul>
              </nav>
            </div>
          </div>
        </aside>
      </div>
    </div>

    <!-- Reading progress indicator -->
    <div class="fixed top-0 left-0 right-0 z-50">
      <div id="reading-progress" class="h-1 bg-gradient-to-r from-orange-400 to-orange-600 transition-all duration-300 ease-out" style="width: 0%"></div>
    </div>

    <!-- Footer with sketchy elements -->
    <footer class="bg-slate-50 border-t-2 border-charcoal mt-24 py-16">
      <div class="max-w-7xl mx-auto px-6">
        <div class="text-center">
          <p class="text-slate-600 font-tiempos">
            Built with love for modular Flutter development
          </p>
          
          <!-- Hand-drawn footer decoration -->
          <svg width="200" height="30" viewBox="0 0 200 30" class="mx-auto mt-8 opacity-40">
            <path d="M20 15 Q50 5 100 15 T180 12" 
                  stroke="#FB923C" 
                  stroke-width="1.5" 
                  fill="none" 
                  stroke-linecap="round"/>
          </svg>
        </div>
      </div>
    </footer>
  </main>

  <style>
    /* Enhanced navigation styles */
    .mini-logo-link {
      transition: transform 0.2s ease;
    }
    
    .mini-logo-link:hover {
      transform: scale(1.1) rotate(5deg);
    }

    /* Sketchy Arrow Animation */
    .sketchy-arrow-back {
      transition: transform 0.2s ease;
    }
    
    .sketchy-arrow-back:hover {
      transform: translateX(-3px);
    }

    /* Fixed Table of Contents Styles */
    .toc-container {
      max-height: calc(100vh - 120px);
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--orange-400) var(--slate-100);
      position: relative;
    }

    .toc-container::-webkit-scrollbar {
      width: 4px;
    }

    .toc-container::-webkit-scrollbar-track {
      background: var(--slate-100);
      border-radius: 2px;
    }

    .toc-container::-webkit-scrollbar-thumb {
      background: var(--orange-400);
      border-radius: 2px;
    }

    .toc-nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .toc-nav li {
      position: relative;
    }

    .toc-nav a {
      color: var(--slate-600);
      text-decoration: none;
      display: block;
      padding: 8px 12px;
      border-left: 3px solid transparent;
      transition: all 0.3s ease;
      font-size: 14px;
      line-height: 1.4;
      position: relative;
      border-radius: 0 4px 4px 0;
    }

    .toc-nav a:hover {
      color: var(--orange-600);
      border-left-color: var(--orange-300);
      background-color: rgba(251, 146, 60, 0.08);
      transform: translateX(2px);
    }

    .toc-nav a.active {
      color: #FFFFFF !important;
      background: linear-gradient(135deg, #F97316, #EA580C) !important;
      border-left-color: #FFFFFF !important;
      font-weight: 700 !important;
      transform: translateX(4px) !important;
      box-shadow: 2px 2px 8px rgba(249, 115, 22, 0.4) !important;
      border-radius: 0 6px 6px 0 !important;
    }

    .toc-nav a.active::before {
      content: 'â–º' !important;
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: auto !important;
      height: auto !important;
      background-color: transparent !important;
      border-radius: 0 !important;
      box-shadow: none !important;
      color: #FFFFFF;
      font-size: 10px;
    }

    /* Nested TOC items for different heading levels */
    .toc-h1 a {
      font-weight: 600;
      font-size: 15px;
      padding: 10px 12px;
      color: var(--slate-700);
    }

    .toc-h2 a {
      font-size: 14px;
      padding: 8px 12px 8px 20px;
      color: var(--slate-600);
    }

    .toc-h3 a {
      font-size: 13px;
      padding: 6px 12px 6px 28px;
      color: var(--slate-500);
      opacity: 0.9;
    }

    .toc-h4 a {
      font-size: 12px;
      padding: 5px 12px 5px 36px;
      color: var(--slate-500);
      opacity: 0.8;
    }

    /* Active states for nested items */
    .toc-h2 a.active,
    .toc-h3 a.active,
    .toc-h4 a.active {
      opacity: 1;
      color: var(--orange-700);
    }

    /* Navigation between pages */
    .prev-page, .next-page {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-page-link {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: var(--slate-50);
      border: 2px solid var(--slate-200);
      border-radius: 8px;
      text-decoration: none;
      color: var(--charcoal);
      transition: all 0.2s ease;
      transform: rotate(-0.5deg);
    }

    .nav-page-link:hover {
      transform: rotate(0deg) translateY(-2px);
      border-color: var(--orange-400);
      box-shadow: 3px 3px 0px var(--orange-400);
    }

    .nav-page-link .page-direction {
      font-size: 12px;
      color: var(--slate-500);
      font-weight: 500;
    }

    .nav-page-link .page-title {
      font-weight: 600;
      color: var(--charcoal);
    }

    /* Reading progress indicator */
    #reading-progress {
      background: linear-gradient(90deg, #FB923C, #F97316, #EA580C);
      box-shadow: 0 2px 4px rgba(251, 146, 60, 0.3);
    }

    /* Responsive improvements */
    @media (max-width: 1024px) {
      .toc-container {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .nav-section h3 {
        font-size: 1rem;
      }
      
      .nav-link {
        padding: 8px 12px;
        font-size: 15px;
      }

      .grid.lg\\:grid-cols-5 {
        grid-template-columns: 1fr;
      }
      
      aside:first-of-type {
        order: 2;
      }
      
      main {
        order: 1;
      }
    }

    /* Print styles */
    @media print {
      .nav-section,
      footer,
      .toc-container,
      #reading-progress {
        display: none;
      }
      
      main {
        grid-column: 1 / -1;
      }
      
      .prose-mosaic {
        max-width: none;
      }
    }

    /* Dark mode support (if needed) */
    @media (prefers-color-scheme: dark) {
      :root {
        --cream: #1F2937;
        --charcoal: #F9FAFB;
        --slate-50: #374151;
        --slate-100: #4B5563;
      }
    }
  </style>

  <script>
  // Generate Table of Contents
  function generateTOC() {
    const article = document.querySelector('.prose-mosaic');
    const tocList = document.getElementById('toc-list');
    
    if (!article || !tocList) return;

    const headings = article.querySelectorAll('h1, h2, h3, h4');
    
    headings.forEach((heading, index) => {
      // Add ID to heading if it doesn't have one
      if (!heading.id) {
        heading.id = `heading-${index}`;
      }

      const level = heading.tagName.toLowerCase();
      const li = document.createElement('li');
      li.className = `toc-${level}`;
      
      const a = document.createElement('a');
      a.href = `#${heading.id}`;
      a.textContent = heading.textContent;
      a.className = 'toc-link';
      
      li.appendChild(a);
      tocList.appendChild(li);
    });
  }

  // Highlight active TOC item based on scroll position
  function updateActiveTOC() {
    const headings = document.querySelectorAll('.prose-mosaic h1, .prose-mosaic h2, .prose-mosaic h3, .prose-mosaic h4');
    const tocLinks = document.querySelectorAll('.toc-link');
    
    if (headings.length === 0 || tocLinks.length === 0) return;

    // Get current scroll position with offset for header
    const scrollPosition = window.scrollY + 100;
    
    let currentHeading = null;
    
    // Find the current heading based on scroll position
    headings.forEach((heading) => {
      const headingTop = heading.offsetTop;
      if (scrollPosition >= headingTop) {
        currentHeading = heading;
      }
    });

    // Remove active class from all TOC links
    tocLinks.forEach(link => link.classList.remove('active'));

    // Add active class to current heading's TOC link
    if (currentHeading) {
      const activeLink = document.querySelector(`.toc-link[href="#${currentHeading.id}"]`);
      if (activeLink) {
        activeLink.classList.add('active');
        
        // Scroll TOC container to show active item
        const tocContainer = document.querySelector('.toc-container');
        if (tocContainer) {
          const linkTop = activeLink.offsetTop;
          const containerHeight = tocContainer.clientHeight;
          const linkHeight = activeLink.clientHeight;
          
          // Smooth scroll TOC to center the active link
          tocContainer.scrollTo({
            top: linkTop - containerHeight / 2 + linkHeight / 2,
            behavior: 'smooth'
          });
        }
      }
    }
  }

  // Update reading progress bar
  function updateReadingProgress() {
    const progressBar = document.getElementById('reading-progress');
    if (!progressBar) return;

    const windowHeight = window.innerHeight;
    const documentHeight = document.documentElement.scrollHeight - windowHeight;
    const scrolled = window.scrollY;
    const progress = (scrolled / documentHeight) * 100;
    
    progressBar.style.width = `${Math.min(progress, 100)}%`;
  }

  // Smooth scroll to heading when clicking TOC link
  function setupSmoothScroll() {
    document.querySelectorAll('.toc-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = link.getAttribute('href');
        const targetElement = document.querySelector(targetId);
        
        if (targetElement) {
          const offset = 80; // Offset for fixed header
          const targetPosition = targetElement.offsetTop - offset;
          
          window.scrollTo({
            top: targetPosition,
            behavior: 'smooth'
          });
        }
      });
    });
  }

  // Initialize everything when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    generateTOC();
    setupSmoothScroll();
    updateActiveTOC();
    updateReadingProgress();
  });

  // Update on scroll with throttling for performance
  let ticking = false;
  window.addEventListener('scroll', () => {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        updateActiveTOC();
        updateReadingProgress();
        ticking = false;
      });
      ticking = true;
    }
  });

  // Update on resize
  window.addEventListener('resize', () => {
    updateActiveTOC();
  });
</script>
 </Layout>
